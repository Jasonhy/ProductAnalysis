{% extends 'base.html' %}
{% load static from staticfiles %}
{% load product_tags %}

{% block title %}
    搜索结果
{% endblock %}


{% block body %}
    <div class="wrapper">
        <!-- Modal -->
        <div class="modal fade" id="loadModal" role="dialog" data-dismiss="modal">
            <div class="modal-dialog">
                <div class="modal-content text-center">
                    <div class="modal-body">
                        <img src="{% static 'gif/loading.gif' %}">
                    </div>
                    <div class="modal-footer text-center">
                     数据正在分析中...
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar">

            <div class="sidebar-wrapper">
                <div class="logo">
                    <a href="#" class="simple-text">
                        搜索列表
                    </a>
                </div>

                <ul class="nav">
                    {% if query %}

                        {% get_search_result_list page.object_list %}

                    {% endif %}

                </ul>

                {% if query %}
                    {% if page.has_previous or page.has_next %}
                        <div class="pager">
                            {% if page.has_previous %}
                                <a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">{% endif %} 上一页
                            {% if page.has_previous %}</a>{% endif %}
                            |
                            {% if page.has_next %}
                                <a href="?q={{ query }}&amp;page={{ page.next_page_number }}">{% endif %}下一页
                            {% if page.has_next %}</a>{% endif %}
                        </div>
                    {% endif %}

                {% endif %}
            </div>
        </div>
        <div class="main-panel">
            <nav class="navbar navbar-default navbar-fixed">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <a class="navbar-brand">十万火急终于出来了</a>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li>
                                <a href="/index/"><p>返回首页</p></a>
                            </li>
                        </ul>
                    </div>
                </div>

            </nav>

            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card ">
                                <div class="clearfix content">
                                    <div class="p-detail">
                                        <a id="p-url">
                                            <img id="p-pic">
                                        </a>
                                    </div>
                                     <div class="p-detail">
                                         <h3 id="p-title"></h3>
                                         <p id="p-price"></p>
                                         <p id="p-score"></p>
                                     </div>
                                </div>

                            </div>

                            <div class="card">
                                <div class="header">
                                    <p class="category">评价总览:分析评价关键字所占的数量,纵坐标表示数量</p>
                                </div>
                                <div class="content">
                                    <img id="img-o">
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="header">
                                    <p class="category">好评率:根据好中差的数量了进行统计</p>
                                </div>
                                <div class="content">
                                    <img id="img-c">
                                </div>
                            </div>

                            <div class="card ">
                                <div class="header">
                                    <p class="category">热度:按照最近的评价日期来分析当前产品是否还是热点话题</p>
                                </div>
                                <div class="content">
                                    <img id="img-h">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block js %}
    <script>
        $(function () {
            $("#set_click").trigger('click');
        });
        function get_plot(id, ele) {
            $(ele).parent().addClass('active');
            $(ele).parent().siblings().removeClass('active');
            $.ajax({
                url: '/make_plot/',
                type: 'POST',
                data: {
                    'p_id': id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'   // csrfmiddlewaretoken添加csrf_token
                },
                dataType: 'JSON',
                success: function (res) {
                    var interval;
                    base_url = "http://127.0.0.1:8080/";
                    try {
                        base_url = "http://127.0.0.1:8080/";
                        var data = res.data;
                        if (res.status == 1) {
                            $("#loadModal").trigger('click');
                            clearInterval(interval);
                            p_imgs = data["p_analysis_imgs"];
                            $("#img-c").attr('src', base_url + p_imgs[0]);
                            $("#img-o").attr('src', base_url + p_imgs[1]);
                            $("#img-h").attr('src', base_url + p_imgs[2]);
                            $("#p-pic").attr('src',data["p_img"]);
                            $("#p-title").text(data['p_title']);
                            $("#p-score").text("总评分: " + data['p_c_score']);
                            $("#p-price").text("价格: " + data["p_price"]);
                            $("#p-url").attr('href',data["p_url"]);
                        } else {
                            $("#loadModal").trigger('click');
                            clearInterval(interval);
                            alert(res.error_msg);
                        }
                    }catch (err){
                        interval = setInterval(get_plot(id,ele), 1000);
                    }
                }
            })
        }

        //模态加载框垂直居中
        function centerModals() {
            $('#loadModal').each(function (i) {
                var $clone = $(this).clone().css('display', 'block').appendTo('body');
                var top = Math.round(($clone.height() - $clone.find('.modal-content').height()) / 2);
                top = top > 0 ? top : 0;
                $clone.remove();
                $(this).find('.modal-content').css("margin-top", top);
            });
        }
        $('#loadModal').on('show.bs.modal', centerModals);
        $(window).on('resize', centerModals);
    </script>
{% endblock %}